#!/usr/bin/env tsx
/**
 * END-TO-END DEMONSTRATION
 * Input: Single URL
 * Output: Rich Wikidata JSON Entity
 */

import { NotabilityChecker } from '../lib/wikidata/notability-checker';
import { entityBuilder } from '../lib/wikidata/entity-builder';
import { webCrawler } from '../lib/crawler';
import { Business } from '../lib/db/schema';
import 'dotenv/config';

const url = process.argv[2] || 'https://motherearthri.com';

console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
console.log('üöÄ END-TO-END DEMONSTRATION: URL ‚Üí Wikidata JSON Entity');
console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
console.log(`üì• INPUT: ${url}\n`);

async function demo() {
  try {
    // Step 1: Crawl
    console.log('‚è≥ Crawling website...');
    const crawlResult = await webCrawler.crawl(url);
    if (!crawlResult.success) throw new Error(`Crawl failed: ${crawlResult.error}`);
    const crawledData = crawlResult.data!;
    console.log(`‚úÖ Extracted: ${crawledData.name}\n`);
    
    // Step 2: Build entity
    console.log('‚è≥ Building Wikidata entity with LLM enhancement and QID resolution...');
    const business: Business = {
      id: 1,
      teamId: 1,
      name: crawledData.name || 'Unknown',
      url: url,
      category: 'unknown',
      location: {
        city: 'Providence',
        state: 'RI',
        country: 'US',
        coordinates: { lat: 41.8240, lng: -71.4128 },
      },
      wikidataQID: null,
      wikidataPublishedAt: null,
      lastCrawledAt: new Date(),
      crawlData: null,
      status: 'crawled',
      createdAt: new Date(),
      updatedAt: new Date(),
    };
    
    const entity = await entityBuilder.buildEntity(business, crawledData);
    console.log(`‚úÖ Generated ${Object.keys(entity.claims).length} properties\n`);
    
    // Step 3: Output
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üì§ OUTPUT: Wikidata JSON Entity (Ready for wbeditentity API)');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    
    console.log(JSON.stringify(entity, null, 2));
    
    console.log('\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log('üìä SUMMARY');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n');
    console.log(`Name: ${entity.labels.en.value}`);
    console.log(`Properties: ${Object.keys(entity.claims).length} PIDs`);
    console.log(`Quality: ${entity.llmSuggestions?.qualityScore || 'N/A'}/100`);
    console.log(`Completeness: ${entity.llmSuggestions?.completeness || 'N/A'}%`);
    
    console.log('\nProperties Generated:');
    Object.keys(entity.claims).forEach(pid => {
      const claim = entity.claims[pid][0];
      const qid = (claim.mainsnak.datavalue?.value as any)?.id;
      const stringVal = typeof claim.mainsnak.datavalue?.value === 'string' 
        ? claim.mainsnak.datavalue.value.substring(0, 40)
        : '';
      const refs = claim.references?.length || 0;
      
      if (qid) {
        console.log(`  ‚Ä¢ ${pid} ‚Üí ${qid} (${refs} refs)`);
      } else if (stringVal) {
        console.log(`  ‚Ä¢ ${pid} = "${stringVal}..." (${refs} refs)`);
      } else {
        console.log(`  ‚Ä¢ ${pid} (${refs} refs)`);
      }
    });
    
    console.log('\n‚úÖ This JSON is ready to POST to: https://test.wikidata.org/w/api.php');
    console.log('   Action: wbeditentity, Format: json, New: item\n');
    
  } catch (error) {
    console.error('\n‚ùå Error:', error);
    process.exit(1);
  }
}

demo();

