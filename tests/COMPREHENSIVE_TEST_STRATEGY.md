# Comprehensive Test Strategy with Playwright Test Agents

**Purpose:** Ensure full function of the repository with comprehensive test coverage  
**Date:** December 2024  
**Leverages:** [Playwright Test Agents](https://playwright.dev/docs/test-agents) for automated test generation

---

## Current Test Status

### âœ… What's Covered
- **Unit Tests**: 40+ tests passing (payment normalization, subscription handlers, API routes)
- **Integration Tests**: Business API, Stripe checkout/webhook
- **E2E Tests**: Subscription flows, Wikidata publishing, Pro user journeys
- **Test Infrastructure**: Fixtures, page objects, helpers

### âŒ Critical Gaps Identified

Based on analysis of the codebase, the following areas need additional testing:

---

## Recommended Additional Tests

### 1. **API Endpoint Coverage** (High Priority)

#### Missing Unit/Integration Tests:
```typescript
// app/api/wikidata/entity/[businessId]/route.ts
- Permission checks for free tier (403 response)
- Entity data retrieval for crawled businesses
- Error handling for non-existent businesses

// app/api/activity/route.ts (if exists)
- Activity log retrieval
- Team-scoped activity filtering

// app/api/settings/route.ts (if exists)
- Settings update/retrieval
- Permission checks

// app/api/notifications/route.ts (if exists)
- Notification retrieval
- Mark as read functionality
```

**Action**: Run unit tests for all API routes:
```bash
pnpm test app/api --run
```

### 2. **Cross-Feature Integration Tests** (High Priority)

#### Missing Integration Flows:
```typescript
// Complete business lifecycle
describe('Business Lifecycle Integration', () => {
  it('free user creates business â†’ crawls â†’ cannot publish (403)')
  it('free user upgrades â†’ crawls â†’ can publish')
  it('pro user creates business â†’ crawls â†’ fingerprints â†’ publishes')
  it('business status transitions: pending â†’ crawled â†’ published')
  it('wikidata QID assignment and retrieval')
})
```

**Action**: Create `tests/integration/business-lifecycle.test.ts`

### 3. **Edge Cases & Error Scenarios** (Medium Priority)

#### Missing Error Handling Tests:
```typescript
// Race condition tests
- Concurrent business creation
- Simultaneous subscription upgrades
- Parallel crawl requests

// Data consistency tests
- Business deletion with active crawl jobs
- Subscription cancellation during active usage
- Team member removal during active operations

// Boundary condition tests
- Maximum businesses (free: 1, pro: 5, agency: 25)
- Long-running crawl operations
- Large entity data handling
```

### 4. **User Permission & Access Control** (High Priority)

#### Missing Permission Tests:
```typescript
describe('Permission & Access Control', () => {
  it('free user cannot access entity API (403)')
  it('free user cannot publish (403)')
  it('free user sees upgrade CTA')
  it('pro user can access all features')
  it('team member permissions (read/write)')
  it('unauthorized access attempts (401/403)')
})
```

### 5. **Data Integrity & Consistency** (Medium Priority)

#### Missing Data Consistency Tests:
```typescript
describe('Data Consistency', () => {
  it('team subscription updates propagate to all endpoints')
  it('business status updates correctly')
  it('wikidata entity data matches business data')
  it('crawl data persists correctly')
  it('fingerprint results are accurate')
})
```

---

## Leveraging Playwright Test Agents

According to [Playwright Test Agents documentation](https://playwright.dev/docs/test-agents), we can use three agents to automatically generate comprehensive test coverage:

### ğŸ­ **Planner Agent** - Generate Test Plans

The planner agent explores your app and produces a Markdown test plan. This is perfect for ensuring we haven't missed critical user flows.

**Setup:**
```bash
npx playwright init-agents --loop=claude
```

**Use Case**: Generate test plans for:
1. Complete user onboarding journey
2. Subscription upgrade workflows
3. Wikidata publishing flows
4. Business management workflows
5. Error recovery scenarios

**Prompt Example:**
```
Generate a comprehensive test plan for all critical user journeys in our KGAAS platform, 
including:
- Free user signup and onboarding
- Subscription upgrade flows
- Business creation and management
- Wikidata publishing workflows
- Error handling and recovery
```

### ğŸ­ **Generator Agent** - Create E2E Tests

The generator agent transforms Markdown plans into executable Playwright tests.

**Use Case**: Auto-generate E2E tests for:
1. Missing user journeys identified by planner
2. Critical paths not yet covered
3. Edge cases and error scenarios

**Input**: Test plans from `specs/` directory (generated by planner)

**Output**: E2E tests in `tests/e2e/` directory

### ğŸ­ **Healer Agent** - Auto-Repair Failing Tests

The healer agent automatically repairs failing tests by:
- Updating locators when UI changes
- Fixing timing issues
- Adjusting assertions for dynamic content

**Use Case**: Maintain test suite as application evolves

**Benefits**:
- Reduces maintenance burden
- Keeps tests up-to-date with UI changes
- Automatically fixes flaky tests

---

## Recommended Test Execution Plan

### Phase 1: API Coverage (Immediate)

```bash
# Run all unit tests for API routes
pnpm test app/api --run --coverage

# Identify missing coverage
pnpm test --coverage --reporter=json > coverage.json
```

**Goal**: 95%+ coverage for all API routes

### Phase 2: Integration Tests (High Priority)

```bash
# Create integration tests for critical flows
# Tests should use real database, mock only external services
pnpm test tests/integration --run
```

**Files to Create**:
- `tests/integration/business-lifecycle.test.ts`
- `tests/integration/subscription-flow.test.ts`
- `tests/integration/permission-checks.test.ts`

### Phase 3: E2E Test Coverage (Using Playwright Agents)

```bash
# Step 1: Generate test plans using Planner
# Use Playwright Test Agents to explore app and generate test plans

# Step 2: Generate E2E tests using Generator
# Transform plans into executable tests

# Step 3: Run E2E tests
pnpm test:e2e

# Step 4: Use Healer to fix any failures
# Auto-repair failing tests
```

**Files to Generate**:
- `specs/onboarding-journey.md` (from planner)
- `specs/subscription-upgrade.md` (from planner)
- `specs/wikidata-publishing.md` (from planner)
- `tests/e2e/onboarding-journey.spec.ts` (from generator)

### Phase 4: Edge Cases & Error Scenarios

```bash
# Test error handling and edge cases
pnpm test tests/integration/edge-cases --run
pnpm test tests/e2e/error-scenarios --run
```

---

## Test Categories Summary

### ğŸ”´ **Critical (Must Have)**
1. âœ… API endpoint coverage (unit/integration)
2. âœ… Permission checks (free vs pro tier)
3. âœ… Subscription upgrade flow (complete)
4. âœ… Wikidata publishing flow (complete)
5. âŒ Cross-feature integration tests
6. âŒ Data consistency tests

### ğŸŸ¡ **Important (Should Have)**
1. âœ… Error handling (basic)
2. âŒ Edge cases (race conditions, boundaries)
3. âŒ User permission matrix
4. âŒ Data integrity checks

### ğŸŸ¢ **Nice to Have**
1. âŒ Performance tests
2. âŒ Load tests
3. âŒ Visual regression tests

---

## Immediate Action Items

### 1. Run Existing Test Suite
```bash
# Unit tests
pnpm test --run

# Integration tests
pnpm test tests/integration --run

# E2E tests
pnpm test:e2e

# Generate coverage report
pnpm test --coverage
```

### 2. Set Up Playwright Test Agents
```bash
# Initialize Playwright Test Agents
npx playwright init-agents --loop=claude

# This creates:
# - .github/agents/ (agent definitions)
# - specs/ (for test plans)
# - tests/seed.spec.ts (seed test)
```

### 3. Generate Test Plans
Use Playwright Test Agents Planner to generate comprehensive test plans for missing flows:
- Onboarding journey
- Business lifecycle
- Error recovery
- Permission scenarios

### 4. Generate E2E Tests
Use Playwright Test Agents Generator to create executable tests from plans

### 5. Run Full Test Suite
```bash
# Complete test run
pnpm test --run
pnpm test:e2e

# With coverage
pnpm test --coverage
```

---

## Test Coverage Goals

### Current Coverage
- **Unit Tests**: ~40 tests (payment/subscription logic)
- **Integration Tests**: ~5 tests (business API, Stripe)
- **E2E Tests**: ~30 tests (user journeys, workflows)

### Target Coverage
- **Unit Tests**: 100+ tests (all API routes, services, utilities)
- **Integration Tests**: 20+ tests (critical flows, cross-feature)
- **E2E Tests**: 50+ tests (all critical user journeys)
- **Code Coverage**: 80%+ for business logic, 95%+ for API routes

---

## Benefits of Playwright Test Agents

According to the [Playwright Test Agents documentation](https://playwright.dev/docs/test-agents):

1. **Automated Test Generation**: Planner explores the app and generates comprehensive test plans
2. **Reduced Manual Work**: Generator transforms plans into executable tests
3. **Self-Healing Tests**: Healer automatically repairs failing tests
4. **Maintainability**: Agents keep tests up-to-date as application evolves
5. **Comprehensive Coverage**: Ensures no critical flows are missed

---

## Next Steps

1. âœ… **Immediate**: Run existing test suite to identify current gaps
2. â³ **Short-term**: Set up Playwright Test Agents
3. â³ **Medium-term**: Generate test plans for missing flows
4. â³ **Long-term**: Maintain tests using Healer agent

---

## References

- [Playwright Test Agents Documentation](https://playwright.dev/docs/test-agents)
- Test Plan: `tests/CHECKOUT_PUBLISHING_TEST_PLAN.md`
- Existing E2E Tests: `tests/e2e/`


